import streamlit as st
import pandas as pd
import random

st.set_page_config(page_title="Brasfoot Global", layout="wide")

# --- CARREGAMENTO DE DADOS ---
@st.cache_data
def load_data():
    try:
        # Lemos o arquivo e ignoramos linhas com erro para n√£o travar
        df = pd.read_csv("times.csv", on_bad_lines='skip')
        # Padroniza√ß√£o absoluta das colunas
        df.columns = ['nome', 'pais', 'divisao', 'forca']
        # Criamos as colunas de pontos e jogos se n√£o existirem
        for col in ['p', 'v', 'e', 'd', 'j']:
            df[col] = 0
        return df
    except Exception as e:
        st.error(f"Erro ao carregar banco de dados: {e}")
        return pd.DataFrame()

# --- L√ìGICA DE FIM DE TEMPORADA ---
def virar_temporada():
    df = st.session_state.tabela_global.copy()
    
    for pais in df['pais'].unique():
        for d in sorted(df[df['pais'] == pais]['divisao'].unique()):
            # Ordena times da divis√£o por pontos (p) e vit√≥rias (v)
            times_div = df[(df['pais'] == pais) & (df['divisao'] == d)].sort_values(by=['p', 'v'], ascending=False)
            
            if len(times_div) >= 2:
                # Subida (se n√£o for a 1¬™ divis√£o)
                if d > 1:
                    subindo = times_div.iloc[:2].index
                    df.loc[subindo, 'divisao'] -= 1
                # Descida (se houver divis√£o abaixo)
                max_div = df[df['pais'] == pais]['divisao'].max()
                if d < max_div:
                    descendo = times_div.iloc[-2:].index
                    df.loc[descendo, 'divisao'] += 1
                    
    # Reseta tudo para o novo ano
    for col in ['p', 'v', 'e', 'd', 'j']: df[col] = 0
    st.session_state.tabela_global = df
    st.session_state.rodada = 1
    st.success("Temporada encerrada! Subidas e descidas processadas.")

# --- INICIALIZA√á√ÉO ---
if 'tabela_global' not in st.session_state:
    st.session_state.tabela_global = load_data()
    st.session_state.rodada = 1

# --- TELA DE SELE√á√ÉO ---
if 'meu_time' not in st.session_state:
    st.title("‚öΩ Brasfoot Global - In√≠cio")
    df = st.session_state.tabela_global
    
    if not df.empty:
        c1, c2 = st.columns(2)
        p_sel = c1.selectbox("Pa√≠s", sorted(df['pais'].unique()))
        d_sel = c2.selectbox("Divis√£o", sorted(df[df['pais'] == p_sel]['divisao'].unique()))
        
        times_list = df[(df['pais'] == p_sel) & (df['divisao'] == d_sel)]['nome'].tolist()
        t_sel = st.selectbox("Escolha seu Clube", sorted(times_list))
        
        if st.button("Iniciar Carreira"):
            st.session_state.meu_time = t_sel
            st.rerun()
else:
    # --- INTERFACE DO TREINADOR ---
    st.sidebar.title(f"üèÜ {st.session_state.meu_time}")
    st.sidebar.write(f"Rodada atual: {st.session_state.rodada}")
    
    if st.sidebar.button("Sair do Jogo"):
        del st.session_state.meu_time
        st.rerun()

    menu = st.tabs(["Jogar Rodada", "Classifica√ß√£o"])

    with menu[0]:
        if st.session_state.rodada <= 10: # Temporada curta de 10 rodadas para teste
            st.subheader(f"Simular Rodada {st.session_state.rodada}")
            if st.button("‚öΩ SIMULAR PARTIDAS"):
                df = st.session_state.tabela_global
                for i, row in df.iterrows():
                    # L√≥gica de pontua√ß√£o baseada na for√ßa
                    res = random.randint(0, 100)
                    if res < (row['forca'] / 2 + 15): # Vit√≥ria
                        df.at[i, 'p'] += 3
                        df.at[i, 'v'] += 1
                    elif res < 75: # Empate
                        df.at[i, 'p'] += 1
                    df.at[i, 'j'] += 1
                st.session_state.rodada += 1
                st.rerun()
        else:
            st.warning("O campeonato terminou!")
            if st.button("üèÜ PR√ìXIMA TEMPORADA"):
                virar_temporada()
                st.rerun()

    with menu[1]:
        p_v = st.selectbox("Ver Pa√≠s", sorted(st.session_state.tabela_global['pais'].unique()))
        d_v = st.selectbox("Ver Divis√£o", sorted(st.session_state.tabela_global[st.session_state.tabela_global['pais'] == p_v]['divisao'].unique()))
        
        filt = st.session_state.tabela_global[(st.session_state.tabela_global['pais'] == p_v) & (st.session_state.tabela_global['divisao'] == d_v)]
        st.table(filt[['nome', 'forca', 'p', 'v', 'j']].sort_values(by=['p', 'v'], ascending=False))